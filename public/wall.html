<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>照片牆</title>

<style>
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
#stage{position:fixed;inset:0;overflow:hidden;background:#000}

.layer{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  opacity:0;
  transform:translate3d(0,0,0) scale(1);
  will-change:transform,opacity,clip-path;
}
.layer.show{opacity:1}

.layer img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  pointer-events:none;
  user-select:none;
  -webkit-user-drag:none;
}

#caption{
  position:fixed;left:0;right:0;bottom:0;
  padding:10px 14px;
  background:linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,0));
  font-size:14px;
}
#hint{
  position:fixed;top:10px;left:10px;
  font-size:12px;color:#fff;
  background:rgba(0,0,0,.45);
  padding:6px 10px;border-radius:10px;
  border:1px solid rgba(255,255,255,.18);
}

/* ===== PPT 擦去（Wipe）—用 clip-path 模擬 ===== */
.wipe-h-init{  clip-path: inset(0 100% 0 0); }   /* 左→右 */
.wipe-h-done{  clip-path: inset(0 0 0 0); }

.wipe-hr-init{ clip-path: inset(0 0 0 100%); }   /* 右→左 */
.wipe-hr-done{ clip-path: inset(0 0 0 0); }

.wipe-v-init{  clip-path: inset(100% 0 0 0); }   /* 上→下 */
.wipe-v-done{  clip-path: inset(0 0 0 0); }

.wipe-vb-init{ clip-path: inset(0 0 100% 0); }   /* 下→上 */
.wipe-vb-done{ clip-path: inset(0 0 0 0); }
</style>
</head>

<body>
  <div id="stage">
    <div id="layerA" class="layer show"><img id="imgA" alt=""></div>
    <div id="layerB" class="layer"><img id="imgB" alt=""></div>
  </div>

  <div id="hint">Queue 模式：不插隊</div>
  <div id="caption">載入中…</div>

<script>
/* ===== 播放參數 ===== */
const SLIDE_MS = 6000;
const TRANS_MS = 1200;
const EASE = "cubic-bezier(0.22,0.61,0.36,1)";
const POLL_MS  = 10000;

/* 特效機率（可調） */
const RATE_WIPE  = 0.22;  // 22%：PPT 擦去
const RATE_MOVE  = 0.28;  // 28%：滑入/縮放
/* 其餘：Crossfade */

const caption = document.getElementById("caption");
const hint = document.getElementById("hint");

const layerA = document.getElementById("layerA");
const layerB = document.getElementById("layerB");
const imgA = document.getElementById("imgA");
const imgB = document.getElementById("imgB");

/* ===== 你原本的 effects（保留） ===== */
const effects = [
  ()=>({x:  8,y:  0,s:1.00}), // from right
  ()=>({x: -8,y:  0,s:1.00}), // from left
  ()=>({x:  0,y:  8,s:1.00}), // from bottom
  ()=>({x:  0,y: -8,s:1.00}), // from top
  ()=>({x:  0,y:  0,s:0.96}), // zoom in
  ()=>({x:  0,y:  0,s:1.04})  // zoom out
];

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function noTrans(el){ el.style.transition = "none"; }
function trans(el){
  el.style.transition =
    `opacity ${TRANS_MS}ms ${EASE}, transform ${TRANS_MS}ms ${EASE}, clip-path ${TRANS_MS}ms ${EASE}`;
}
function clearClip(el){
  el.classList.remove(
    "wipe-h-init","wipe-h-done",
    "wipe-hr-init","wipe-hr-done",
    "wipe-v-init","wipe-v-done",
    "wipe-vb-init","wipe-vb-done"
  );
  el.style.clipPath = "";
}
const wipeKinds = ["h","hr","v","vb"];
function wipeInitClass(kind){
  return kind==="h" ? "wipe-h-init"
       : kind==="hr"? "wipe-hr-init"
       : kind==="v" ? "wipe-v-init"
       : "wipe-vb-init";
}
function wipeDoneClass(kind){
  return kind==="h" ? "wipe-h-done"
       : kind==="hr"? "wipe-hr-done"
       : kind==="v" ? "wipe-v-done"
       : "wipe-vb-done";
}
function pickMode(){
  const r = Math.random();
  if (r < RATE_WIPE) return "wipe";
  if (r < RATE_WIPE + RATE_MOVE) return "move";
  return "fade";
}

/* ====== Queue 核心 ======
   - itemsById: public_id -> item（含 url/uploader/created_at）
   - queue: public_id[]  播放佇列（循環）
*/
const itemsById = new Map();
let queue = [];
let busy = false;
let showA = true;

/* 將 Cloudinary 清單同步進 itemsById + queue（不改變 queue 既有順序） */
function syncFromList(list){
  // 1) 更新/補進 itemsById
  for (const it of list){
    itemsById.set(it.public_id, it);
  }

  // 2) 移除 Cloudinary 已不存在的（被刪掉）
  const live = new Set(list.map(x => x.public_id));
  for (const id of Array.from(itemsById.keys())){
    if (!live.has(id)) itemsById.delete(id);
  }
  queue = queue.filter(id => itemsById.has(id));

  // 3) 把「新出現但 queue 還沒有」的 id 加到尾巴（保持不插隊）
  //    注意：list 是新到舊，但我們這裡要「尾巴加入」且保持上傳先後合理：
  //    所以把 list 反過來（舊→新）再逐一補尾巴，順序才符合時間。
  const oldestToNewest = [...list].reverse();
  for (const it of oldestToNewest){
    if (!queue.includes(it.public_id)){
      queue.push(it.public_id);
    }
  }
}

async function loadList(){
  const r = await fetch("/api/photos", { cache:"no-store" });
  const j = await r.json();
  if (j.ok) {
    syncFromList(j.items || []);
  }
}

function captionOf(it){
  const who = it.uploader ? `（${it.uploader}）` : "";
  return `${new Date(it.created_at).toLocaleString()}${who}`;
}

/* 播放一張：shift -> 播 -> push */
async function playNext(){
  if (busy) return;
  if (!queue.length){
    caption.textContent = "目前沒有照片";
    return;
  }
  busy = true;

  const id = queue.shift();
  const it = itemsById.get(id);
  // 理論上不會缺，但保險
  if (!it){
    busy = false;
    return;
  }

  // 播完回尾巴（循環）
  queue.push(id);

  const cur = showA ? layerA : layerB;
  const nxt = showA ? layerB : layerA;
  const nextImg = showA ? imgB : imgA;

  nextImg.src = it.url;
  caption.textContent = captionOf(it);

  // reset
  noTrans(cur); noTrans(nxt);
  cur.classList.add("show");
  nxt.classList.add("show");
  cur.style.opacity = "1";
  cur.style.transform = "translate3d(0,0,0) scale(1)";
  clearClip(cur);
  clearClip(nxt);

  const mode = pickMode();

  if (mode === "wipe"){
    const kind = pick(wipeKinds);
    hint.textContent = "特效：PPT 擦去（不插隊）";

    nxt.style.opacity = "1";
    nxt.style.transform = "translate3d(0,0,0) scale(1)";
    nxt.classList.add(wipeInitClass(kind));

    requestAnimationFrame(()=>{
      trans(nxt); trans(cur);
      nxt.classList.add(wipeDoneClass(kind));
      setTimeout(()=>{ cur.style.opacity = "0"; }, 160);
    });

  } else if (mode === "move"){
    const fx = pick(effects)();
    hint.textContent = "特效：滑入/縮放（不插隊）";

    nxt.style.opacity = "0";
    nxt.style.transform = `translate3d(${fx.x}%,${fx.y}%,0) scale(${fx.s})`;

    requestAnimationFrame(()=>{
      trans(nxt); trans(cur);
      nxt.style.opacity = "1";
      nxt.style.transform = "translate3d(0,0,0) scale(1)";
      setTimeout(()=>{ cur.style.opacity = "0"; }, 150);
    });

  } else {
    hint.textContent = "特效：Crossfade（不插隊）";

    nxt.style.opacity = "0";
    nxt.style.transform = "translate3d(0,0,0) scale(1)";

    requestAnimationFrame(()=>{
      trans(nxt); trans(cur);
      nxt.style.opacity = "1";
      setTimeout(()=>{ cur.style.opacity = "0"; }, 120);
    });
  }

  setTimeout(()=>{
    noTrans(cur);
    cur.classList.remove("show");
    cur.style.opacity = "0";
    clearClip(cur);

    noTrans(nxt);
    nxt.style.opacity = "1";
    nxt.style.transform = "translate3d(0,0,0) scale(1)";
    clearClip(nxt);

    showA = !showA;
    busy = false;
  }, TRANS_MS + 260);
}

/* 保底輪詢 + 輪播 */
setInterval(()=>{ loadList().catch(()=>{}); }, POLL_MS);
setInterval(()=>{ playNext(); }, SLIDE_MS);

/* 快速測試：按 N 下一張 */
document.addEventListener("keydown", (e)=>{
  if (e.key.toLowerCase()==="n") playNext();
});

/* SSE：新照片只 push 到尾巴（不插隊、不立刻播） */
function startSSE(){
  const es = new EventSource("/api/stream");
  es.addEventListener("new", (evt)=>{
    try{
      const msg = JSON.parse(evt.data);
      if (msg && msg.item){
        // 更新 itemsById
        itemsById.set(msg.item.public_id, msg.item);

        // 只加到尾巴（避免重複）
        if (!queue.includes(msg.item.public_id)){
          queue.push(msg.item.public_id);
        }
        // 不呼叫 playNext()、不重設任何指標
      }
    }catch{}
  });
}

(async ()=>{
  await loadList();
  playNext();
  startSSE();
})();
</script>
</body>
</html>
