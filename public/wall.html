<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>照片牆</title>

<style>
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui}
#stage{position:fixed;inset:0;overflow:hidden}

.layer{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  opacity:0;
  transform:translate3d(0,0,0) scale(1);
  will-change:transform,opacity;
}
.layer.show{opacity:1}

.layer img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  user-select:none;
  pointer-events:none;
}

#caption{
  position:fixed;left:0;right:0;bottom:0;
  padding:10px 14px;
  background:linear-gradient(to top,rgba(0,0,0,.75),transparent);
  font-size:14px;
}

#hint{
  position:fixed;top:10px;left:10px;
  font-size:12px;
  background:rgba(0,0,0,.45);
  padding:6px 10px;
  border-radius:10px;
}
</style>
</head>

<body>
<div id="stage">
  <div id="layerA" class="layer show"><img id="imgA"></div>
  <div id="layerB" class="layer"><img id="imgB"></div>
</div>

<div id="hint">自然隨機版</div>
<div id="caption"></div>

<script>
/* ===== 可調參數（已是舒服預設） ===== */
const SLIDE_MS = 6000;
const TRANS_MS = 1200;
const EASE = "cubic-bezier(0.22,0.61,0.36,1)";
const POLL_MS = 10000;

/* 特效機率 */
const EFFECT_RATE = 0.35; // 35% 用特效，其餘純淡入淡出

const layerA=document.getElementById("layerA");
const layerB=document.getElementById("layerB");
const imgA=document.getElementById("imgA");
const imgB=document.getElementById("imgB");
const caption=document.getElementById("caption");
const hint=document.getElementById("hint");

let items=[],idx=0,showA=true,busy=false;

/* ===== 效果池（自然幅度） ===== */
const effects=[
  ()=>({x:  8,y:  0,s:1.00}), // from right
  ()=>({x: -8,y:  0,s:1.00}), // from left
  ()=>({x:  0,y:  8,s:1.00}), // from bottom
  ()=>({x:  0,y: -8,s:1.00}), // from top
  ()=>({x:  0,y:  0,s:0.96}), // zoom in
  ()=>({x:  0,y:  0,s:1.04})  // zoom out
];

async function loadList(){
  const r=await fetch("/api/photos",{cache:"no-store"});
  const j=await r.json();
  if(j.ok) items=j.items||[];
  if(idx>=items.length) idx=0;
}

function captionOf(it){
  return `${new Date(it.created_at).toLocaleString()}${it.uploader?`（${it.uploader}）`:""}`;
}

function styleNo(el){ el.style.transition="none"; }
function styleYes(el){ el.style.transition=`opacity ${TRANS_MS}ms ${EASE}, transform ${TRANS_MS}ms ${EASE}`; }

async function next(){
  if(busy||!items.length) return;
  busy=true;

  const it=items[idx++%items.length];
  caption.textContent=captionOf(it);

  const cur=showA?layerA:layerB;
  const nxt=showA?layerB:layerA;
  const img=showA?imgB:imgA;

  img.src=it.url;

  const useFx=Math.random()<EFFECT_RATE;
  const fx=useFx?effects[Math.floor(Math.random()*effects.length)]():{x:0,y:0,s:1};

  hint.textContent=useFx?"特效":"淡入淡出";

  styleNo(nxt);
  nxt.classList.add("show");
  nxt.style.opacity=0;
  nxt.style.transform=`translate(${fx.x}%,${fx.y}%) scale(${fx.s})`;

  requestAnimationFrame(()=>{
    styleYes(nxt);
    styleYes(cur);

    nxt.style.opacity=1;
    nxt.style.transform="translate(0,0) scale(1)";

    setTimeout(()=>{ cur.style.opacity=0; },150); // OUT 稍晚一點
  });

  setTimeout(()=>{
    styleNo(cur);
    cur.classList.remove("show");
    cur.style.opacity=0;

    styleNo(nxt);
    nxt.style.opacity=1;
    nxt.style.transform="translate(0,0) scale(1)";

    showA=!showA;
    busy=false;
  },TRANS_MS+200);
}

/* ===== 初始化 ===== */
setInterval(loadList,POLL_MS);
setInterval(next,SLIDE_MS);

document.addEventListener("keydown",e=>{
  if(e.key.toLowerCase()==="n") next();
});

(async()=>{
  await loadList();
  next();
})();
</script>
</body>
</html>
