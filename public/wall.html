<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>照片牆</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
    #stage{position:fixed;inset:0;overflow:hidden;background:#000}

    .layer{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      will-change: transform, opacity;
      opacity:0;
      transform: translate3d(0,0,0) scale(1);
    }
    .layer.show{ opacity:1; }

    .layer img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    #caption{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 14px;
      background:linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,0));
      font-size:14px;
    }

    /* Debug 角落資訊：如果你看不到這個，就表示不是新版本 */
    #hint{
      position:fixed;top:10px;left:10px;
      font-size:13px;color:#fff;
      background:rgba(0,0,0,.55); padding:8px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      line-height:1.35;
      z-index:9999;
    }

    :root{
      --dur: 1600ms;
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    .enter{ transition: opacity var(--dur) var(--ease), transform var(--dur) var(--ease); }
    .exit { transition: opacity var(--dur) var(--ease), transform var(--dur) var(--ease); }

    .from-right{ transform: translate3d(18%,0,0) scale(1.00); }
    .from-left { transform: translate3d(-18%,0,0) scale(1.00); }
    .from-top  { transform: translate3d(0,-18%,0) scale(1.00); }
    .from-bottom{transform: translate3d(0,18%,0) scale(1.00); }
    .zoom-in   { transform: translate3d(0,0,0) scale(0.85); }
    .zoom-out  { transform: translate3d(0,0,0) scale(1.12); }

    .to-center{ transform: translate3d(0,0,0) scale(1); opacity:1; }

    .to-left   { transform: translate3d(-14%,0,0) scale(1.00); opacity:0; }
    .to-right  { transform: translate3d(14%,0,0) scale(1.00); opacity:0; }
    .to-top    { transform: translate3d(0,-14%,0) scale(1.00); opacity:0; }
    .to-bottom { transform: translate3d(0,14%,0) scale(1.00); opacity:0; }
    .fade-out  { transform: translate3d(0,0,0) scale(1.00); opacity:0; }

    #stage, .layer, .layer img { backface-visibility:hidden; }
  </style>
</head>
<body>
  <div id="stage">
    <div id="layerA" class="layer show"><img id="imgA" alt=""></div>
    <div id="layerB" class="layer"><img id="imgB" alt=""></div>
  </div>

  <div id="hint">特效測試版 v2025-12-12A<br>載入中…</div>
  <div id="caption">載入中…</div>

<script>
const VERSION = "v2025-12-12A";
const SLIDE_MS = 8000;    // 每張停留時間
const TRANS_MS = 1600;    // 轉場時間（越長越明顯）
const POLL_MS  = 10000;

document.documentElement.style.setProperty('--dur', TRANS_MS + 'ms');

const capEl = document.getElementById('caption');
const hintEl = document.getElementById('hint');

const layerA = document.getElementById('layerA');
const layerB = document.getElementById('layerB');
const imgA = document.getElementById('imgA');
const imgB = document.getElementById('imgB');

let items = [];
let idx = 0;
let showingA = true;
let inTransition = false;

const effectSequence = [
  { enter: "from-right", exit: "to-left" },
  { enter: "from-left",  exit: "to-right" },
  { enter: "from-top",   exit: "to-bottom" },
  { enter: "from-bottom",exit: "to-top" },
  { enter: "zoom-in",    exit: "fade-out" },
  { enter: "zoom-out",   exit: "fade-out" }
];
let effectIndex = 0;

async function loadList() {
  const res = await fetch("/api/photos", { cache: "no-store" });
  const data = await res.json();
  if (!data.ok) return;
  items = data.items || [];
  if (idx >= items.length) idx = 0;
}

function captionOf(it){
  const who = it.uploader ? `（${it.uploader} 上傳）` : "";
  return `${new Date(it.created_at).toLocaleString()} ${who}`;
}

function clearClasses(el){
  el.className = "layer";
  el.style.opacity = "0";
  el.style.transform = "translate3d(0,0,0) scale(1)";
}

function applyEnter(el, enterClass){
  clearClasses(el);
  el.classList.add("enter", enterClass);
  el.style.opacity = "0";
  void el.offsetWidth;
  el.classList.add("to-center");
  el.style.opacity = "1";
}

function applyExit(el, exitClass){
  el.classList.add("exit", exitClass);
  el.style.opacity = "0";
}

async function showNext(forceNewest=false){
  if (inTransition) return;
  if (!items.length) {
    hintEl.innerHTML = `特效測試版 ${VERSION}<br>目前沒有照片`;
    capEl.textContent = "目前沒有照片";
    imgA.removeAttribute("src");
    imgB.removeAttribute("src");
    return;
  }

  if (forceNewest) idx = 0;
  const it = items[idx % items.length];
  idx++;

  const nextImgEl = showingA ? imgB : imgA;
  const nextLayer = showingA ? layerB : layerA;
  const curLayer  = showingA ? layerA : layerB;

  nextImgEl.src = it.url;
  capEl.textContent = captionOf(it);

  const eff = effectSequence[effectIndex % effectSequence.length];
  effectIndex++;

  hintEl.innerHTML =
    `特效測試版 ${VERSION}<br>` +
    `Enter: <b>${eff.enter}</b> / Exit: <b>${eff.exit}</b><br>` +
    `照片數：${items.length}（按 N 下一張）`;

  inTransition = true;

  nextLayer.classList.add("show");
  applyEnter(nextLayer, eff.enter);
  applyExit(curLayer, eff.exit);

  setTimeout(() => {
    clearClasses(curLayer);
    curLayer.classList.remove("show");

    clearClasses(nextLayer);
    nextLayer.classList.add("show");
    nextLayer.style.opacity = "1";
    nextLayer.style.transform = "translate3d(0,0,0) scale(1)";

    showingA = !showingA;
    inTransition = false;
  }, TRANS_MS + 50);
}

setInterval(() => { loadList().catch(()=>{}); }, POLL_MS);
setInterval(() => { showNext(false); }, SLIDE_MS);

document.addEventListener('keydown', (e) => {
  if (e.key.toLowerCase() === 'n') showNext(false);
});

function startSSE(){
  const es = new EventSource("/api/stream");
  es.addEventListener("new", (evt) => {
    try{
      const msg = JSON.parse(evt.data);
      if (msg && msg.item) {
        items.unshift(msg.item);
        showNext(true);
      }
    }catch{}
  });
}

(async function init(){
  await loadList();
  await showNext(true);
  startSSE();
})();
</script>
</body>
</html>
